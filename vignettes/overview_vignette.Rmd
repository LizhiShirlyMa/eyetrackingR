---
title: "A Brief Overview of EyetrackingR"
author: "Brock Ferguson & Jacob Dink"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Load dataset and dependencies

```{r}
load('../data/word_recognition.rda')

library(ggplot2)
```

## Load and set data options for **eyetrackingR** library.

```{r results='hide'}
library("eyetrackingR")

# set data options
data_options = set_data_options( 
  trial_column = "Trial",
  time_column = "TimeFromTrialOnset",
  trackloss_column = "TrackLoss",
  aoi_columns = c('Animate','Inanimate'),
  participant_column = "ParticipantName"
)
```

## Verify state of each relevant column.

```{r}
data <- verify_dataset(word_recognition, data_options)
```

## Subset data to examine "response" window, and deal with trackloss.

We are going to:

* Subset the data into the time window of interest
* Treat looks outside of our AOI as if they are trackloss
* Calculate the amount of trackloss in each trial
* Remove trials with over 50% trackloss
* Remove all remaining trackloss samples from our dataset (so that, in each sample, the toddler is looking either to one AOI or the other)

```{r}
# subset to response window
response_window <- subset_by_window(data, data_options, window_start_time = 15500, window_end_time = 21000, rezero = FALSE)

# convert non-AOI looks to trackloss
response_window <- convert_non_aoi_to_trackloss(response_window, data_options)

# analyze amount of trackloss by subjects and trials
trackloss <- trackloss_analysis(data = response_window,
                                data_options = data_options)

# show trackloss
trackloss

response_window_clean <- clean_by_trackloss(data = response_window,
                                            data_options = data_options, 
                                            trial_prop_thresh = .25)

# remove all trackloss from remaining trials
response_window_clean <- remove_trackloss(response_window_clean, data_options, delete_rows=TRUE)
```

## Create "Target" condition based on TrialName

```{r}
# create "Target" condition column based on trial names
response_window_clean$Target <- ifelse(grepl('(Spoon|Bottle)', response_window_clean$Trial), 'Inanimate', 'Animate')
response_window_clean$Target <- factor(response_window_clean$Target)
```

## Describe and visualize results

```{r}
(data_summary <- describe_data(response_window_clean, data_options, describe_column='Animate', group_columns=c('ParticipantName','Target')))

# aggregate across trials within subjects in time analysis
response_time <- make_time_sequence_data(response_window_clean, data_options, time_bin_size = 100, 
                                 predictor_columns = c("Target"),
                                 aoi = c("Animate")
                            )

# visualize time results
plot(response_time, predictor_column = "Target") + 
  ylab("Proportion Looking to Animate") + theme_light() +
  coord_cartesian(ylim = c(0,1))

# aggregate by subject across the response window
response_window_agg_by_sub <- make_time_window_data(response_window_clean, 
                                             data_options, 
                                             predictor_columns=c('Target','Age','MCDI_Total'),
                                             summarize_by = "ParticipantName")

# take a quick peek at data
plot(response_window_agg_by_sub)
plot(response_window_agg_by_sub, predictor_columns="Target")

# show condition means
describe_data(response_window_agg_by_sub, describe_column = "Prop", group_columns = "Target")
```

## Simple t-test

```{r}
# simple t-test between conditions
t.test(ArcSin ~ Target, data=response_window_agg_by_sub, paired=TRUE)
```

## Mixed-effects models on windowed data

```{r}
library("lme4")
response_window_agg <- make_time_window_data(response_window_clean, 
                                             data_options, 
                                             aois='Animate', 
                                             predictor_columns=c('Target','Age','MCDI_Total'))

# mixed-effects linear model on subject*trial data
response_window_agg$TargetC <- ifelse(response_window_agg$Target == 'Animate', .5, -.5)
response_window_agg$TargetC <- scale(response_window_agg$TargetC, center=TRUE, scale=FALSE)

model <- lmer(Elog ~ TargetC + (1 + TargetC | Trial) + (1 | ParticipantName), 
              data = response_window_agg, REML = FALSE)
summary(model)
drop1(model,~.,test="Chi")
```

## Growth curve analysis

```{r}
# growth curve analysis on time series
response_time$TargetC <- ifelse(response_time$Target == 'Animate', .5, -.5)
response_time$TargetC <- scale(response_time$TargetC, center=TRUE, scale=FALSE)

model <- lmer(Elog ~ TargetC*(ot1 + ot2 + ot3 + ot4 + ot5) + (1 | Trial) + (1 | ParticipantName), 
              data = response_time, REML = FALSE)
summary(model)
drop1(model,~.,test="Chi")

# visualize GCA model
ggplot(response_time, aes(x=Time, y=Elog, color=Target)) +
  stat_summary(fun.y=mean, geom="point") +
  stat_summary(aes(y=predict(model,response_time,re.form=NA)), 
               fun.y=mean, geom="line", linetype='solid', size=2)
```

## Onset-contingent analysis

```{r}
# recode AOIs to target & distractor
response_window_clean$TrialTarget <- 
  ifelse(response_window_clean$Target == 'Animate', response_window_clean$Animate, response_window_clean$Inanimate)
response_window_clean$TrialDistractor <- 
  ifelse(response_window_clean$Target == 'Animate', response_window_clean$Inanimate, response_window_clean$Animate)

onsets <- make_onset_data(response_window_clean, data_options, onset_time = 15500, fixation_window_length = 100, target_aoi='TrialTarget')

plot(onsets, predictor_columns = "Target") + theme(legend.text=element_text(size=5))

# compare switch times
onset_switches <- make_switch_data(onsets, predictor_columns = "Target")

plot(onset_switches, predictor_columns = "Target") 

# center predictor:
onset_switches$FirstAOIC <- ifelse(onset_switches$FirstAOI == 'TrialTarget', .5, -.5)
onset_switches$FirstAOIC <- scale(onset_switches$FirstAOIC, center=TRUE, scale=FALSE)

model <- lmer(FirstSwitch ~ FirstAOIC + 
                (1 + FirstAOIC | Trial) + (1 + FirstAOIC | ParticipantName), data=onset_switches, REML=FALSE)
summary(model)
drop1(model,~.,test="Chi")
```

## Bootstrapped splines analysis.

Do a proper within-subjects analysis for the familiar trials.

```{r}
bootstrapped_familiar <- make_boot_splines_data(response_time, 
                                                predictor_column = 'Target', 
                                                within_subj = TRUE, 
                                                samples = 1000, 
                                                resolution = 100, 
                                                alpha = .05, 
                                                smoother = 'smooth.spline') 

plot(bootstrapped_familiar)

bootstrap_analysis_familiar <- analyze_boot_splines(bootstrapped_familiar)

# same as above, because, for within-subjects data, it always plots the difference score estimates
#plot(bootstrap_analysis_familiar) 

summary(bootstrap_analysis_familiar)
```


## Cluster Analysis

Perform a different type of bootstrapping analyses (Maris & Oostenveld, 2007), sometimes referred to as a cluster analysis. This analysis takes a summed statistic for each cluster of time bins that pass some level of significance, and compares each to the "null" distribution of sum statistics (obtained by bootstrap resampling data within the largest of the clusters).

This type of analysis should often give similar results to the above, with the main advantage is that it can be used with several types of statistical techniques (t.test, wilcox.test, lm, and lmer), so that continuous predictors, covariates, etc. can be included in the model being tested; and the main disadvantage is that it is slower.

```{r}
response_time_by_subj <- make_time_sequence_data(response_window_clean, data_options, time_bin_size = 225, 
                                 predictor_columns = c("Target"),
                                 aois = c("Animate"), 
                                 summarize_by = "ParticipantName"
                            )

df_timeclust = make_time_cluster_data(response_time_by_subj, 
                                      test= "t.test", paired = TRUE,
                                      predictor_column = "Target", 
                                      threshold = 2.5) # <--- just to make things more challenging
plot(df_timeclust) +
  ylab("T-Statistic")
summary(df_timeclust)

clust_analysis = analyze_time_clusters(df_timeclust, within_subj = TRUE, paired=TRUE, samples=500)
clust_analysis

plot(clust_analysis) 
```





