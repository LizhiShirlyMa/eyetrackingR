---
title: "A Brief Overview of EyetrackingR"
author: "Brock Ferguson & Jacob Dink"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Load dataset

```{r}
load('../data/word_recognition.rda')
```

## Load and set data options for **eyetrackingR** library.

```{r results='hide'}
devtools::load_all("../")

# set data options
data_options = set_data_options( 
  trial_column = "Trial",
  time_column = "TimeFromTrialOnset",
  trackloss_column = "TrackLoss",
  aoi_columns = c('Animate','Inanimate'),
  participant_column = "ParticipantName"
)
```

## Verify state of each relevant column.

```{r}
data <- verify_dataset(word_recognition, data_options)
```

## Deal with trackloss.

We are going to:

* Treat looks outside of our AOI as if they are trackloss
* Calculate the amount of trackloss in each trial
* Remove trials with over 50% trackloss
* Remove all remaining trackloss samples from our dataset (so that, in each sample, the toddler is looking either to one AOI or the other)

```{r}
# convert non-AOI looks to trackloss
data <- convert_non_aoi_to_trackloss(data, data_options)

# analyze amount of trackloss by subjects and trials
trackloss <- trackloss_analysis(data, data_options, window_start = 15500, window_end = 21000)

# show trackloss
trackloss

data <- clean_by_trackloss(data,
                           data_options, 
                           trial_prop_thresh = .25,
                           window_start = 15500,
                           window_end = 21000)

# remove all trackloss from remaining trials
data <- remove_trackloss(data, data_options, delete_rows=TRUE)
```

## Subset data to examine "response" window, and create "Target" condition based on TrialName

```{r}
# subset to response window
response_window <- subset_by_window(data, data_options, window_start = 15500, window_end = 21000)

# create "Target" condition column based on trial names
response_window$Target <- ifelse(grepl('(Spoon|Bottle)', response_window$Trial), 'Inanimate', 'Animate')
response_window$Target <- factor(response_window$Target)
```

## Describe and visualize over results

```{r}
(data_summary <- describe_data(response_window, data_options, describe_column='Animate', group_columns=c('ParticipantName','Target')))

# aggregate across trials within subjects in time analysis
response_time <- make_time_sequence_data(response_window, data_options, time_bin_size = 100, 
                                 predictor_columns = c("Target"),
                                 aoi = c("Animate")
                            )

# visualize time results
plot(response_time, predictor_column = "Target")

# aggregate by subject across the response window
response_window_agg_by_sub <- make_time_window_data(response_window, 
                                             data_options, 
                                             aois='Animate', 
                                             predictor_columns=c('Target','Age','MCDI_Total'),
                                             summarize_by = "ParticipantName")

# take a quick peek at mean proportion by Target condition
plot(response_window_agg_by_sub, predictor_columns="Target")

# visualize our aggregated data with a boxplot (data should match previous plot)
ggplot(response_window_agg_by_sub, aes(x=Target, y=Prop)) +
                                  geom_boxplot() +
                                  geom_point(position=position_jitter(.1))

# show condition means
describe_data(response_window_agg_by_sub, describe_column = "Prop", group_columns = "Target")
```

## Simple t-test

```{r}
# simple t-test between conditions
t.test(ArcSin ~ Target, data=response_window_agg_by_sub, paired=TRUE)
```

## Mixed-effects models on windowed data

```{r}
library("lme4")
response_window_agg <- make_time_window_data(response_window, 
                                             data_options, 
                                             aois='Animate', 
                                             predictor_columns=c('Target','Age','MCDI_Total'))

# mixed-effects linear model on subject*trial data
response_window_agg$TargetC <- ifelse(response_window_agg$Target == 'Animate', .5, -.5)
response_window_agg$TargetC <- scale(response_window_agg$TargetC, center=T, scale=F)

model <- lmer(Elog ~ TargetC + (1 + TargetC | Trial) + (1 | ParticipantName), data = response_window_agg, REML = F)
summary(model)
drop1(model,~.,test="Chi")
```

## Growth curve analysis

```{r}
# growth curve analysis on time series
response_time$TargetC <- ifelse(response_time$Target == 'Animate', .5, -.5)
response_time$TargetC <- scale(response_time$TargetC, center=T, scale=F)

model <- lmer(Elog ~ TargetC*(ot1 + ot2 + ot3 + ot4 + ot5) + (1 | Trial) + (1 | ParticipantName), data = response_time, REML = F)
summary(model)
drop1(model,~.,test="Chi")

# visualize GCA model
ggplot(response_time, aes(x=Time, y=Elog, color=Target)) +
  stat_summary(fun.y=mean, geom="point") +
  stat_summary(aes(y=predict(model,response_time,re.form=NA)), fun.y=mean, geom="line", linetype='solid', size=2)
```

## Onset-contingent analysis

```{r}
# recode AOIs to target & distractor
response_window$TrialTarget <- ifelse(response_window$Target == 'Animate', response_window$Animate, response_window$Inanimate)
response_window$TrialDistractor <- ifelse(response_window$Target == 'Animate', response_window$Inanimate, response_window$Animate)

onsets <- make_onset_data(response_window, data_options, onset_time = 15500, fixation_window_length = 100, target_aoi='TrialTarget')

plot(onsets, predictor_columns = "Target")

# compare switch times
onset_switches <- make_switch_data(onsets, predictor_columns = "Target")

plot(onset_switches, predictor_columns = "Target") 

# center predictor:
onset_switches$FirstAOIC <- ifelse(onset_switches$FirstAOI == 'TrialTarget', .5, -.5)
onset_switches$FirstAOIC <- scale(onset_switches$FirstAOIC, center=TRUE, scale=FALSE)

model <- lmer(FirstSwitch ~ FirstAOIC + (1 + FirstAOIC | Trial) + (1 + FirstAOIC | ParticipantName), data=onset_switches, REML=F)
summary(model)
drop1(model,~.,test="Chi")
```

## Bootstrapped splines analysis.

Do a proper within-subjects analysis for the familiar trials.

```{r}
bootstrapped_familiar <- make_boot_splines_data(response_time, 
                                                predictor_column = 'Target', 
                                                within_subj = TRUE, 
                                                samples = 1000, 
                                                resolution = 100, 
                                                alpha = .05, 
                                                smoother = 'smooth.spline') 

plot(bootstrapped_familiar)

bootstrap_analysis_familiar <- analyze_boot_splines(bootstrapped_familiar)

# same as above, because, for within-subjects data, it always plots the difference score estimates
plot(bootstrap_analysis_familiar) # TO DO: this should tell you in which direction the difference was taken

summary(bootstrap_analysis_familiar)
```


## Cluster Analysis

Perform a different type of bootstrapping analyses (Maris & Oostenveld, 2007), sometimes referred to as a cluster analysis. This analysis takes a summed statistic for each cluster of time bins that pass some level of significance, and compares each to the "null" distribution of sum statistics (obtained by bootstrap resampling data within the largest of the clusters).

This type of analysis should often give similar results to the above, with the main advantage is that it can be used with several types of statistical techniques (t.test, wilcox.test, lm, and lmer), so that continuous predictors, covariates, etc. can be included in the model being tested; and the main disadvantage is that it is slower.

```{r}
response_time_by_subj <- make_time_sequence_data(response_window, data_options, time_bin_size = 225, 
                                 predictor_columns = c("Target"),
                                 aois = c("Animate"), 
                                 summarize_by = "ParticipantName"
                            )

df_timeclust = make_time_cluster_data(response_time_by_subj, 
                                      test= "t.test", paired = TRUE,
                                      predictor_column = "Target", 
                                      threshold = 2.5) # <--- just to make things more challenging
plot(df_timeclust) 
summary(df_timeclust)

clust_analysis = analyze_time_clusters(df_timeclust, within_subj = TRUE, paired=TRUE, samples=500)
clust_analysis

plot(clust_analysis) 
```





