---
title: "eyetrackingR Walkthrough"
output:
  html_document:
  toc: true
  theme: united
---
  
Analysis Timestamp:
```{r}
date()
```

## Dependencies

```{r results='hide'}
library(ggplot2, quietly=T)
library(reshape2, quietly=T)
library(lme4, quietly=T)
library(plyr, quietly=T)
library(dplyr, quietly=T)
```

## Load dataset

Ideally, this would be a function in the package (you can embed data in the 'data' folder of a package)

```{r}
load('word-recognition.Rdata')
```

## Load and set data options for **eyetrackingR** library.

```{r results='hide'}
source('./../analyze-eyetracking.R')

# set data options
data_options = set_data_options( 
  trial_column = "Trial",
  time_column = "TimeFromTrialOnset",
  trackloss_column = "TrackLoss",
  aoi_columns = c('Animate','Inanimate'),
  participant_column = "ParticipantName"
)
```

## Verify state of each relevant column.

```{r}
data <- verify_dataset(data, data_options)
```

## Deal with trackloss.

We are going to:

* Treat looks outside of our AOI as if they are trackloss
* Calculate the amount of trackloss in each trial
* Remove trials with over 50% trackloss
* Remove all remaining trackloss samples from our dataset (so that, in each sample, the toddler is looking either to one AOI or the other)

```{r}
# convert non-AOI looks to trackloss
data <- convert_non_aoi_to_trackloss(data, data_options)

# analyze amount of trackloss by subjects and trials
trackloss <- trackloss_analysis(data, data_options, window_start = 15500, window_end = 21000)

# show trackloss
trackloss

data <- clean_by_trackloss(data,
                           data_options, 
                           trial_prop_thresh = .25,
                           window_start = 15500,
                           window_end = 21000)

# remove all trackloss from remaining trials
data <- remove_trackloss(data, data_options, delete_rows=TRUE)
```

## Subset data to examine "response" window, and create "Target" condition based on TrialName

```{r}
# subset to response window
response_window <- subset_by_window(data, data_options, window_start = 15500, window_end = 21000)

# create "Target" condition column based on trial names
response_window$Target <- ifelse(grepl('(Spoon|Bottle)', response_window$Trial), 'Inanimate', 'Animate')
response_window$Target <- factor(response_window$Target)
```

## Describe and visualize over results

```{r}
data_summary <- describe_data(response_window, data_options, dv='Animate', factors=c('ParticipantName','Target'))

# aggregate across trials within subjects in time analysis
response_time <- time_shape(response_window, data_options, time_bin_size = 100, 
                                 condition_columns = c("Target"),
                                 aoi = c("Animate")
                            )

# visualize time results
plot(response_time, data_options, condition_column = "Target")

# aggregate by subject across the response window
response_window_agg <- window_shape(response_window, data_options, aoi='Animate', condition_columns=c('Target','Age','MCDI_Total'))

# take a quick peek at mean proportion by Target condition
# note this automatically aggregates across trials by subjects
plot(response_window_agg, data_options, x_axis_column="Target")

subject_means <- response_window_agg %>%
                          group_by(ParticipantName,Target,Age,MCDI_Total) %>%
                          summarise(MeanAnimate = mean(Prop,na.rm=T), N=length(Prop), ArcSin = asin(sqrt(MeanAnimate))) %>%
                          ungroup()

# visualize our aggregated data with a boxplot (data should match previous plot)
ggplot(subject_means, aes(x=Target, y=MeanAnimate)) +
                                  geom_boxplot() +
                                  geom_point(position=position_jitter(.1))

# show condition means
condition_means <- subject_means %>%
                    group_by(Target) %>%
                    summarise(Mean=mean(MeanAnimate), SD=sd(MeanAnimate), N=length(MeanAnimate))

condition_means
```

## Simple t-test

```{r}
# simple t-test between conditions
t.test(ArcSin ~ Target, data=subject_means, paired=T)
```

## Mixed-effects models on window-shaped data

```{r}
# mixed-effects linear model on subject*trial data
response_window_agg$TargetC <- ifelse(response_window_agg$Target == 'Animate', .5, -.5)
response_window_agg$TargetC <- scale(response_window_agg$TargetC, center=T, scale=F)

model <- lmer(Elog ~ TargetC + (1 + TargetC | Trial) + (1 | ParticipantName), data = response_window_agg, REML = F)
summary(model)
drop1(model,~.,test="Chi")
```

## Growth curve analysis

```{r}
# growth curve analysis on time series
response_time$TargetC <- ifelse(response_time$Target == 'Animate', .5, -.5)
response_time$TargetC <- scale(response_time$TargetC, center=T, scale=F)

model <- lmer(Elog ~ TargetC*(ot1 + ot2 + ot3 + ot4 + ot5) + (1 | Trial) + (1 | ParticipantName), data = response_time, REML = F)
summary(model)
drop1(model,~.,test="Chi")

# visualize GCA model
ggplot(response_time, aes(x=Time, y=Elog, color=Target)) +
  stat_summary(fun.y=mean, geom="point") +
  stat_summary(aes(y=predict(model,response_time,re.form=NA)), fun.y=mean, geom="line", linetype='solid', size=2)
```

## Onset-contingent analysis

```{r}
# recode AOIs to target & distractor
response_window$TrialTarget <- ifelse(response_window$Target == 'Animate', response_window$Animate, response_window$Inanimate)
response_window$TrialDistractor <- ifelse(response_window$Target == 'Animate', response_window$Inanimate, response_window$Animate)

onsets <- onset_shape(response_window, data_options, onset_time = 15500, fixation_window_length = 100, target_aoi='TrialTarget')

plot(onsets, data_options)

# compare switch times
onset_switches <- switch_shape(onsets, data_options)

plot(onset_switches, data_options) # TO DO: remove NA from grouping

onset_switches$FirstAOIC <- ifelse(onset_switches$FirstAOI == 'TrialTarget', .5, -.5)
onset_switches$FirstAOIC <- scale(onset_switches$FirstAOIC, center=T, scale=F)

model <- lmer(FirstSwitch ~ FirstAOIC + (1 + FirstAOIC | Trial) + (1 + FirstAOIC | ParticipantName), data=onset_switches, REML=F)
summary(model)
drop1(model,~.,test="Chi")
```

## Bootstrapped splines analysis.

Do a proper within-subjects analysis for the familiar trials.

```{r}
bootstrapped_familiar <- bootstrapped_shape(response_time, data_options, condition_column = 'Target', within_subj = TRUE, samples = 1000, resolution = 100, alpha = .05, smoother = 'smooth.spline') 

plot(bootstrapped_familiar, data_options)

familiar_bootstrapped_intervals <- analyze_bootstraps(bootstrapped_familiar, data_options)

# same as above, because, for within-subjects data, it always plots the difference score estimates
plot(familiar_bootstrapped_intervals, data_options) # TO DO: this should tell you in which direction the difference was taken

familiar_bootstrapped_divergences <- analyze_bootstrapped_divergences(familiar_bootstrapped_intervals, data_options)
familiar_bootstrapped_divergences
```


## Cluster Analysis

```{r}
response_time_by_subj <- time_shape(response_window, data_options, time_bin_size = 100, 
                                 condition_columns = c("Target"),
                                 aoi = c("Animate"), 
                                 summarize_by = "ParticipantName"
                            )
seq_bin = analyze_time_bins(response_time_by_subj, data_options, condition_column = "Target", paired = TRUE)
plot(seq_bin) 

analyze_time_clusters(response_time_by_subj, data_options, condition_column = "Target", within_subj = TRUE, paired= TRUE, samples=25)

```





