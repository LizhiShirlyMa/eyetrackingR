---
title: "Testing Properties of Divergence Analyses with Simulations"
author: "Jacob Dink"
date: "November 15, 2015"
output: html_document
---

### Notes/Brainstorming:

Tests:

 * Divergence halfway through Trial
    * FA %
    * FWER
    * Correct Discovery %
    * Estimated Time-of-Divergence (bias?)
    * Magnitude of divergence?
 * Conditioning high-FWER analyses on preliminary overall analyses
    * Only run boot-splines when there's an overall effect across entire window
    * Only run boot-splines when there's an interaction term in the growth-curve
 * By-Items Analysis vs. Collapsing Across Items
    * Cluster-Analysis does well
    * Splines does poorly, but easy to fix
 * Effects of time-bin with high amount of noise 
    * Splines do well
    * Cluster-analysis does poorly
 * Adjusting Threshold of Cluster-Analysis
    * A prior
    * Post-hoc
 * Abrupt End-of-Divergence for Brief Period
    * Does splines falsely smooth this away?

Wrap each of the tests in a for loop that varies:

 * Sample-size (both subjects, items)
 * Effect-size
 * Length of trial
 * ??


```{r, echo=FALSE}
library("eyetrackingR")
library("ggplot2")
suppressPackageStartupMessages(library("dplyr"))
library("pbapply")

set.seed(40)
tb_size = 250
f <- function(d, i) mean(d[i], na.rm=TRUE)
```

### Example Fake Data with No Effect

No preference for either AOI (5 second trial, N=16, 6 items per participant, between subjects)

```{r}
df <- simulate_eyetrackingr_data()
df_time <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", aois = "AOI1")
plot(df_time, predictor_column = "Condition")

##
ggplot(df_time, aes(x = Time, y = Prop, group = Condition, color=Condition)) +
  stat_summary(fun.y = mean, geom="line") +
  facet_wrap(~ Participant)

ggplot(df_time, aes(x = Time, y = Prop, group = Condition, color=Condition)) +
  stat_summary(fun.y = mean, geom="line") +
  facet_wrap(~ Item)

num_time_bins <- length(unique(df_time$TimeBin))
```

### Example Fake Data with Effect

A strong preference for AOI1 in the "high" condition emerges halfway through the trial (5 second trial, N=16, 6 items per participant, between subjects).

```{r}
set.seed(48)
df <- simulate_eyetrackingr_data(pref = .80, pref_window = c(2500,5000))
df_time <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", aois = "AOI1")
plot(df_time, predictor_column = "Condition")

##
ggplot(df_time, aes(x = Time, y = Prop, group = Condition, color=Condition)) +
  stat_summary(fun.y = mean, geom="line") +
  facet_wrap(~ Participant)
ggplot(df_time, aes(x = Time, y = Prop, group = Condition, color=Condition)) +
  stat_summary(fun.y = mean, geom="line") +
  facet_wrap(~ Item)
```

## T.Tests

### No Correction:

```{r}
set.seed(5)
effect_start <- 2500
results1 <- bind_rows( pbreplicate(50, simplify = FALSE, expr = {
  df <- simulate_eyetrackingr_data(pref = .80, pref_window = c(effect_start,5000))
  df_time_sub <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", aois = "AOI1", 
                                         summarize_by = "Participant")
  tb_anal <- analyze_time_bins(df_time_sub, predictor_column = "Condition", test = "t.test", alpha = .05, quiet=TRUE)
  tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
  with(tb_anal, 
       data.frame(false_alarm_bins = sum(Sig[Time <  effect_start-tb_size]),
            correct_discovery_bins = sum(Sig[Time >= effect_start]),
            first_discovery_time = Time[Time >= effect_start-tb_size & Sig][1],
            avg_rt = mean(df$RT, na.rm=TRUE),
            rt_lower_quart = quantile(df$RT, probs = .25),
            rt_upper_quart = quantile(df$RT, probs = .75)
       ))
}) )

cat(sep = "",
  "\nSensitivity:",
  "\n\tAverage Correct-Discovery Rate:\t", mean(results1$correct_discovery_bins) / (num_time_bins/2),
  "\n\tRate of No Discovery:\t\t", mean(results1$correct_discovery_bins==0),
  "\n\tAvg. Time of 1st Diverg. (CI):\t", mean(results1$first_discovery_time, na.rm=TRUE), " ",
  "(",paste(round(quantile(boot::boot(results1$first_discovery_time, f, R=500)$t, probs = c(.025, .975))), collapse=", "),")",
  "\n\tActual Time of Effect Onset:\t", effect_start, 
  "\n\tAverage RT:\t\t\t", mean(results1$avg_rt),
  "\nFalse Alarms:",
  "\n\tAverage FA Rate:\t", mean(results1$false_alarm_bins) / (num_time_bins/2),
  "\n\tAverage FWER:\t\t", mean(results1$false_alarm_bins != 0)
)
```

### Bonf. correction:

```{r}
set.seed(5)
effect_start <- 2500
results2 <- bind_rows( pbreplicate(50, simplify = FALSE, expr = {
  df <- simulate_eyetrackingr_data(pref = .80, pref_window = c(effect_start,5000))
  df_time_sub <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", aois = "AOI1", 
                                         summarize_by = "Participant")
  tb_anal <- analyze_time_bins(df_time_sub, predictor_column = "Condition", test = "t.test", alpha = .05/num_time_bins, quiet=TRUE)
  tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
  with(tb_anal, 
       data.frame(false_alarm_bins = sum(Sig[Time <  effect_start-tb_size]),
            correct_discovery_bins = sum(Sig[Time >= effect_start]),
            first_discovery_time = Time[Time >= effect_start-tb_size & Sig][1],
            avg_rt = mean(df$RT, na.rm=TRUE)
       ))
}) )

cat(sep = "",
  "\nSensitivity:",
  "\n\tAverage Correct-Discovery Rate:\t", mean(results2$correct_discovery_bins) / (num_time_bins/2),
  "\n\tRate of No Discovery:\t\t", mean(results2$correct_discovery_bins==0),
  "\n\tAverage Time of 1st Divergence:\t", mean(results2$first_discovery_time, na.rm=TRUE), " ",
  "(",paste(round(quantile(boot::boot(results2$first_discovery_time, f, R=500)$t, probs = c(.025, .975))), collapse=", "),")",
  "\n\tActual Time of Effect Onset:\t", effect_start, 
  "\n\tAverage RT:\t\t\t", mean(results2$avg_rt),
  "\nFalse Alarms:",
  "\n\tAverage FA Rate:\t", mean(results2$false_alarm_bins) / (num_time_bins/2),
  "\n\tAverage FWER:\t\t", mean(results2$false_alarm_bins != 0)
)
```

## Boot-Splines

### No Correction:

```{r}
set.seed(5)
effect_start <- 2500
results3 <- bind_rows( pbreplicate(50, simplify = FALSE, expr = {
  df <- simulate_eyetrackingr_data(pref = .80, pref_window = c(effect_start,5000))
  df_time_sub <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", aois = "AOI1", 
                                         summarize_by = "Participant")
  bs_dat <- make_boot_splines_data(df_time_sub, predictor_column = "Condition", within_subj = FALSE, alpha = .05, samples = 250)
  bs_anal <- analyze_boot_splines(bs_dat)
  with(bs_anal, 
       data.frame(false_alarm_bins = sum(Significant[Time <  effect_start-tb_size]),
            correct_discovery_bins = sum(Significant[Time >= effect_start]),
            first_discovery_time = Time[Time >= effect_start-tb_size & Significant][1],
            avg_rt = mean(df$RT, na.rm=TRUE)
       ))
}) )

cat(sep = "",
  "\nSensitivity:",
  "\n\tAverage Correct-Discovery Rate:\t", mean(results3$correct_discovery_bins) / (num_time_bins/2),
  "\n\tRate of No Discovery:\t\t", mean(results3$correct_discovery_bins==0),
  "\n\tAverage Time of 1st Divergence:\t", mean(results3$first_discovery_time, na.rm=TRUE), " ",
  "(",paste(round(quantile(boot::boot(results3$first_discovery_time, f, R=500)$t, probs = c(.025, .975))), collapse=", "),")",
  "\n\tActual Time of Effect Onset:\t", effect_start, 
  "\n\tAverage RT:\t\t\t", mean(results3$avg_rt),
  "\nFalse Alarms:",
  "\n\tAverage FA Rate:\t", mean(results3$false_alarm_bins) / (num_time_bins/2),
  "\n\tAverage FWER:\t\t", mean(results3$false_alarm_bins != 0)
)
```

### Bonf. Correction:

```{r}
set.seed(8)
effect_start <- 2500
results4 <- bind_rows( pbreplicate(50, simplify = FALSE, expr = {
  df <- simulate_eyetrackingr_data(pref = .80, pref_window = c(effect_start,5000))
  df_time_sub <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", aois = "AOI1", 
                                         summarize_by = "Participant")
  bs_dat <- make_boot_splines_data(df_time_sub, predictor_column = "Condition", within_subj = FALSE, alpha = .05/num_time_bins, 
                                   samples = 250)
  bs_anal <- analyze_boot_splines(bs_dat)
  with(bs_anal, 
       data.frame(false_alarm_bins = sum(Significant[Time <  effect_start-tb_size]),
            correct_discovery_bins = sum(Significant[Time >= effect_start]),
            first_discovery_time = Time[Time >= effect_start-tb_size & Significant][1],
            avg_rt = mean(df$RT, na.rm=TRUE)
       ))
}) )

cat(sep = "",
  "\nSensitivity:",
  "\n\tAverage Correct-Discovery Rate:\t", mean(results4$correct_discovery_bins) / (num_time_bins/2),
  "\n\tRate of No Discovery:\t\t", mean(results4$correct_discovery_bins==0),
  "\n\tAverage Time of 1st Divergence:\t", mean(results4$first_discovery_time, na.rm=TRUE), " ",
  "(",paste(round(quantile(boot::boot(results4$first_discovery_time, f, R=500)$t, probs = c(.025, .975))), collapse=", "),")",
  "\n\tActual Time of Effect Onset:\t", effect_start, 
  "\n\tAverage RT:\t\t\t", mean(results4$avg_rt),
  "\nFalse Alarms:",
  "\n\tAverage FA Rate:\t", mean(results4$false_alarm_bins) / (num_time_bins/2),
  "\n\tAverage FWER:\t\t", mean(results4$false_alarm_bins != 0)
)
```

### Cluster Analysis:

Note, this uses a t-test on each bin (not lmer).

```{r}
set.seed(.1)
effect_start <- 2500
results5 <- bind_rows( pbreplicate(50, simplify = FALSE, expr = {
  df <- simulate_eyetrackingr_data(pref = .80, pref_window = c(effect_start,5000))
  df_time_sub <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", aois = "AOI1", 
                                         summarize_by = "Participant")
  cl_dat <- make_time_cluster_data(data = df_time_sub, predictor_column = "Condition", test = "t.test", threshold = 2.13, quiet = TRUE)
  if ( nrow(get_time_clusters(cl_dat))>0 ) {
    cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = 50, parallel = TRUE)
    cl_clusts <- get_time_clusters(cl_anal)
    cl_clusts$NumBins <- with(cl_clusts, (EndTime - StartTime)/tb_size)
    cl_sig_clusts <- filter(cl_clusts, cl_clusts$Probability<.05)
    out <- with(cl_sig_clusts, 
         data.frame(false_alarm_bins = sum(NumBins[StartTime <  effect_start-tb_size]),
                    correct_discovery_bins = sum(NumBins[StartTime >= effect_start]),
                    first_discovery_time = StartTime[StartTime >= effect_start-tb_size][1],
                    avg_rt = mean(df$RT, na.rm=TRUE)
         ))
  } else {
    out <- data.frame(false_alarm_bins = 0, 
                      correct_discovery_bins = 10,  # <----- hard-coded, fix later
                      first_discovery_time = NA, 
                      avg_rt = mean(df$RT, na.rm=TRUE) )
  }
  return(out)
}))

cat(sep = "",
  "\nSensitivity:",
  "\n\tAverage Correct-Discovery Rate:\t", mean(results5$correct_discovery_bins) / (num_time_bins/2),
  "\n\tRate of No Discovery:\t\t", mean(results5$correct_discovery_bins==0),
  "\n\tAverage Time of 1st Divergence:\t", mean(results5$first_discovery_time, na.rm=TRUE), " ",
  "(",paste(round(quantile(boot::boot(results5$first_discovery_time, f, R=500)$t, probs = c(.025, .975))), collapse=", "),")",
  "\n\tActual Time of Effect Onset:\t", effect_start, 
  "\n\tAverage RT:\t\t\t", mean(results5$avg_rt),
  "\nFalse Alarms:",
  "\n\tAverage FA Rate:\t", mean(results5$false_alarm_bins) / (num_time_bins/2),
  "\n\tAverage FWER:\t\t", mean(results5$false_alarm_bins != 0)
)
```