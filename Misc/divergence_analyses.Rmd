---
title: "Testing Types of Divergence Analyses with Simulations"
author: "Jacob Dink"
date: "November 17, 2015"
output: html_document
---

## Prelims:
```{r}
stopifnot(grepl(pattern = "Misc", x = getwd()))
#devtools::install_github('jwdink/eyetrackingR')
library(eyetrackingR)
library(pbapply)
library(dplyr)
doMC::registerDoMC()
library(foreach)

params_to_test_template <- expand.grid(NumSubjects = c(10,30,60),
                                       NumItems    = c(10),
                                       Pref        = c(.65, .75, .85),
                                       SimNum      = 1:20)

effect_start <- 2500
trial_length <- 5000
tb_size <- 100
num_time_bins <- trial_length / tb_size
num_no_effect_time_bins <- (effect_start/trial_length)*num_time_bins
num_effect_time_bins    <- (1-effect_start/trial_length)*num_time_bins
bootstrap_samples <- 250
cluster_samples <- 250
```

```{r}
make_time_data <- function(i, param_df) {
  df <- simulate_eyetrackingr_data(num_participants = param_df[i,"NumSubjects"], 
                                   num_items_per_condition = param_df[i,"NumItems"], 
                                   trial_length = trial_length, 
                                   pref = param_df[i,"Pref"],
                                   pref_window = c(effect_start, trial_length)
                                   )
  df_time <- make_time_sequence_data(data = df, time_bin_size = tb_size, aois = "AOI1", predictor_columns = "Condition",
                                     summarize_by = "Participant")
}
```

## T.Tests:

### Uncorrected:

```{r}
t_test_df <- params_to_test_template
t_test_df$Alpha <- .05
t_test_df$Test <- "t_test"
t_test_df$Adjustment <- ""
```

```{r}
if (!file.exists('sim_results/t_test_results.RDS')) {
  t_test_results <- pblapply(X = 1:nrow(t_test_df), FUN = function(i) {
    df_time <- make_time_data(i, t_test_df)
    tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "t.test", alpha = t_test_df[i,"Alpha"], quiet=TRUE)
    tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
    return(tb_anal)
  })
  saveRDS(t_test_results, file = "sim_results/t_test_results.RDS")
}
```

```{r}
t_test_results <- readRDS("sim_results/t_test_results.RDS")

for (i in seq_along(t_test_results)) {
  model <- t_test_results[[i]]
  # add to df:
  t_test_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  t_test_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  t_test_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

### Bonf. Corrected

```{r}
t_test_bonf_df <- params_to_test_template
t_test_bonf_df$Alpha <- .05 / num_time_bins
t_test_bonf_df$Test <- "t_test"
t_test_bonf_df$Adjustment <- "bonferroni"
```

```{r}
if (!file.exists('sim_results/t_test_bonf_results.RDS')) {
  t_test_bonf_results <- pblapply(X = 1:nrow(t_test_bonf_df), FUN = function(i) {
    df_time <- make_time_data(i, t_test_bonf_df)
    tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "t.test", alpha = t_test_bonf_df[i,"Alpha"], quiet=TRUE)
    tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
    return(tb_anal)
  })
  saveRDS(t_test_bonf_results, file = "sim_results/t_test_bonf_results.RDS")
}
```

```{r}
t_test_bonf_results <- readRDS("sim_results/t_test_bonf_results.RDS")

for (i in seq_along(t_test_bonf_results)) {
  model <- t_test_bonf_results[[i]]
  # add to df:
  t_test_bonf_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  t_test_bonf_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  t_test_bonf_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

## Boot-Splines:

### Uncorrected:

```{r}
boot_splines_df <- params_to_test_template
boot_splines_df$Alpha <- .05
boot_splines_df$Test <- "boot_splines"
boot_splines_df$Adjustment <- ""
```

```{r}
if (!file.exists('sim_results/boot_splines_results.RDS')) {
  boot_splines_results <- pblapply(X = 1:nrow(boot_splines_df), FUN = function(i) {
    df_time <- make_time_data(i, boot_splines_df)
    tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "boot_splines", 
                                 samples = bootstrap_samples,
                                 within_subj = FALSE,
                                 alpha = boot_splines_df[i,"Alpha"], 
                                 quiet=TRUE)
    tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
    return(tb_anal)
  })
  saveRDS(boot_splines_results, file = "sim_results/boot_splines_results.RDS")
}
```

```{r}
boot_splines_results <- readRDS("sim_results/boot_splines_results.RDS")

for (i in seq_along(boot_splines_results)) {
  model <- boot_splines_results[[i]]
  # add to df:
  boot_splines_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  boot_splines_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  boot_splines_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

### Bonf. Corrected:

```{r}
boot_splines_bonf_df <- params_to_test_template
boot_splines_bonf_df$Alpha <- .05  / num_time_bins
boot_splines_bonf_df$Test <- "boot_splines"
boot_splines_bonf_df$Adjustment <- "bonferroni"
```

```{r}
if (!file.exists('sim_results/boot_splines_bonf_results.RDS')) {
  boot_splines_bonf_results <- pblapply(X = 1:nrow(boot_splines_bonf_df), FUN = function(i) {
    df_time <- make_time_data(i, boot_splines_bonf_df)
    tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "boot_splines", 
                                 samples = bootstrap_samples,
                                 within_subj = FALSE,
                                 alpha = boot_splines_bonf_df[i,"Alpha"], 
                                 quiet=TRUE)
    tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
    return(tb_anal)
  })
  saveRDS(boot_splines_bonf_results, file = "sim_results/boot_splines_bonf_results.RDS")
}
```

```{r}
boot_splines_bonf_results <- readRDS("sim_results/boot_splines_bonf_results.RDS")

for (i in seq_along(boot_splines_bonf_results)) {
  model <- boot_splines_bonf_results[[i]]
  # add to df:
  boot_splines_bonf_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  boot_splines_bonf_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  boot_splines_bonf_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

## Cluster Analysis:

### Using t-tests, with Low. Threshold:

```{r}
time_cluster_low_thresh_df <- params_to_test_template
time_cluster_low_thresh_df$ThresholdAlpha <- .10
time_cluster_low_thresh_df$Alpha <- .05
time_cluster_low_thresh_df$Test <- "time_cluster_ttest"
time_cluster_low_thresh_df$Adjustment <- "low_threshold"
```

```{r}
if (!file.exists('sim_results/time_cluster_low_thresh_results.RDS')) {
  time_cluster_low_thresh_results <- foreach(i=1:nrow(time_cluster_low_thresh_df)) %dopar% {
    df_time <- make_time_data(i, time_cluster_low_thresh_df)
    cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "t.test", 
                                      threshold = qt(p = time_cluster_low_thresh_df[i,"ThresholdAlpha"]/2, 
                                                     df = time_cluster_low_thresh_df[i,"NumSubjects"]) # <-- set thresh w/alpha
    )
    cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples, parallel = TRUE)
    return(cl_anal)
  }
  saveRDS(time_cluster_low_thresh_results, file = "sim_results/time_cluster_low_thresh_results.RDS")
}
```

```{r}
time_cluster_low_thresh_results <- readRDS("sim_results/time_cluster_low_thresh_results.RDS")

for (i in seq_along(time_cluster_low_thresh_results)) {
  model <- get_time_clusters(time_cluster_low_thresh_results[[i]])
  
  if (nrow(model) > 0) {
    model <- model %>%
    mutate(Sig = Probability < .05,
           PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
           ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
           DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
           ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
    filter(Sig)
    
    # add to df:
  time_cluster_low_thresh_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
  time_cluster_low_thresh_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
  time_cluster_low_thresh_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect,na.rm=T), no = NA))
  }
  else {
    time_cluster_low_thresh_df[i,"FABins"] <- 0
    time_cluster_low_thresh_df[i,"CDBins"] <- 0
    time_cluster_low_thresh_df[i,"FirstDiscTime"] <- NA
  }
}
```

### Using t-tests, with High. Threshold:

```{r}
time_cluster_high_thresh_df <- params_to_test_template
time_cluster_high_thresh_df$ThresholdAlpha <- .05
time_cluster_high_thresh_df$Alpha <- .05
time_cluster_high_thresh_df$Test <- "time_cluster_ttest"
time_cluster_high_thresh_df$Adjustment <- "high_threshold"
```

```{r}
if (!file.exists('sim_results/time_cluster_high_thresh_results.RDS')) {
  time_cluster_high_thresh_results <- foreach(i=1:nrow(time_cluster_high_thresh_df)) %dopar% {
    df_time <- make_time_data(i, time_cluster_high_thresh_df)
    cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "t.test", 
                                      threshold = qt(p = time_cluster_high_thresh_df[i,"ThresholdAlpha"]/2, 
                                                     df = time_cluster_high_thresh_df[i,"NumSubjects"]) # <-- set thresh w/alpha
    )
    cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples, parallel = TRUE)
    return(cl_anal)
  }
  saveRDS(time_cluster_high_thresh_results, file = "sim_results/time_cluster_high_thresh_results.RDS")
}
```

```{r}
time_cluster_high_thresh_results <- readRDS("sim_results/time_cluster_high_thresh_results.RDS")

for (i in seq_along(time_cluster_high_thresh_results)) {
  model <- get_time_clusters(time_cluster_high_thresh_results[[i]])
  if (nrow(model) > 0) {
    model <- model %>%
      mutate(Sig = Probability < .05,
             PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
             ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
             DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
             ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
      filter(Sig)
    
    # add to df:
    time_cluster_high_thresh_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
    time_cluster_high_thresh_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
    time_cluster_high_thresh_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect,na.rm=T), no = NA))
  }
  else {
    time_cluster_high_thresh_df[i,"FABins"] <- 0
    time_cluster_high_thresh_df[i,"CDBins"] <- 0
    time_cluster_high_thresh_df[i,"FirstDiscTime"] <- NA
  }
}
```

### Using boot-splines, with Low. Threshold:

```{r}
time_cluster_low_thresh_boot_df <- params_to_test_template
time_cluster_low_thresh_boot_df$ThresholdAlpha <- .10
time_cluster_low_thresh_boot_df$Alpha <- .05
time_cluster_low_thresh_boot_df$Test <- "time_cluster_boot"
time_cluster_low_thresh_boot_df$Adjustment <- "low_threshold"
```

```{r}
if (!file.exists('sim_results/time_cluster_low_thresh_boot_results.RDS')) {
  time_cluster_low_thresh_boot_results <- foreach(i=1:nrow(time_cluster_low_thresh_boot_df)) %dopar% {
    df_time <- make_time_data(i, time_cluster_low_thresh_boot_df)
    cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "boot_splines", within_subj = FALSE,
                                      alpha = time_cluster_low_thresh_boot_df[i,"ThresholdAlpha"])
    cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples,
                                     boot_samples = bootstrap_samples,
                                     parallel = TRUE)
    return(cl_anal)
  }
  saveRDS(time_cluster_low_thresh_boot_results, file = "sim_results/time_cluster_low_thresh_boot_results.RDS")
}
```

```{r}
time_cluster_low_thresh_boot_results <- readRDS("sim_results/time_cluster_low_thresh_boot_results.RDS")

for (i in seq_along(time_cluster_low_thresh_boot_results)) {
  model <- get_time_clusters(time_cluster_low_thresh_boot_results[[i]])
  if (nrow(model) > 0) {
    model <- model %>%
      mutate(Sig = Probability < .05,
             PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
             ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
             DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
             ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
      filter(Sig)
    
    # add to df:
    time_cluster_low_thresh_boot_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
    time_cluster_low_thresh_boot_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
    time_cluster_low_thresh_boot_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect,na.rm=T), no = NA))
  }
  else {
    time_cluster_low_thresh_boot_df[i,"FABins"] <- 0
    time_cluster_low_thresh_boot_df[i,"CDBins"] <- 0
    time_cluster_low_thresh_boot_df[i,"FirstDiscTime"] <- NA
  }
}
```

### Using boot-splines, with High. Threshold:

```{r}
time_cluster_high_thresh_boot_df <- params_to_test_template
time_cluster_high_thresh_boot_df$ThresholdAlpha <- .05
time_cluster_high_thresh_boot_df$Alpha <- .05
time_cluster_high_thresh_boot_df$Test <- "time_cluster_boot"
time_cluster_high_thresh_boot_df$Adjustment <- "high_threshold"

```

```{r}
if (!file.exists('sim_results/time_cluster_high_thresh_boot_results.RDS')) {
  time_cluster_high_thresh_boot_results <- foreach(i=1:nrow(time_cluster_high_thresh_boot_df)) %dopar% {
    df_time <- make_time_data(i, time_cluster_high_thresh_boot_df)
    cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "boot_splines", within_subj = FALSE,
                                      alpha = time_cluster_high_thresh_boot_df[i,"ThresholdAlpha"])
    cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples,
                                     boot_samples = bootstrap_samples,
                                     parallel = TRUE)
    return(cl_anal)
  }
  saveRDS(time_cluster_high_thresh_boot_results, file = "sim_results/time_cluster_high_thresh_boot_results.RDS")
}
```

```{r}
time_cluster_high_thresh_boot_results <- readRDS("sim_results/time_cluster_high_thresh_boot_results.RDS")

for (i in seq_along(time_cluster_high_thresh_boot_results)) {
  model <- get_time_clusters(time_cluster_high_thresh_boot_results[[i]])
  if (nrow(model) > 0) {
    model <- model %>%
      mutate(Sig = Probability < .05,
             PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
             ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
             DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
             ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
      filter(Sig)
    
    # add to df:
    time_cluster_high_thresh_boot_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
    time_cluster_high_thresh_boot_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
    time_cluster_high_thresh_boot_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect,na.rm=T), no = NA))
  }
  else {
    time_cluster_high_thresh_boot_df[i,"FABins"] <- 0
    time_cluster_high_thresh_boot_df[i,"CDBins"] <- 0
    time_cluster_high_thresh_boot_df[i,"FirstDiscTime"] <- NA
  }
}
```

# Visualizations

```{r}
# print the date so I can see how long this took
date()

get_mean_ci <- function(vec) {
  if (length(vec)<1) return("NA, NA, NA")
  if (all(is.na(vec))) return("NA, NA, NA")
  bootstrapped <- boot::boot(vec, function(x,i) mean(x[i],na.rm=TRUE), 500)
  paste(c(mean(vec,na.rm=TRUE), boot::boot.ci( bootstrapped, type="perc")$percent[4:5]), collapse = ", " )
}
master_df <- bind_rows(boot_splines_bonf_df, boot_splines_df, 
                       t_test_bonf_df, t_test_df, 
                       time_cluster_low_thresh_df, time_cluster_high_thresh_df,
                       time_cluster_low_thresh_boot_df, time_cluster_high_thresh_boot_df)

summary_per_cell_fa <- master_df %>%
  group_by(NumSubjects, NumItems, Alpha, Test, Adjustment) %>%
  summarise(ErrorRate    = get_mean_ci(FABins/num_no_effect_time_bins),
            FWER         = get_mean_ci(FABins != 0)) %>%
  tidyr::gather(key = "Measure", value = "Value", ErrorRate,FWER) %>%
  tidyr::separate(col = Value, sep = ", ", into = c("Mean", "CI_Low", "CI_High"), remove = TRUE) %>%
  readr::type_convert()

ggplot(filter(summary_per_cell_fa, Measure=="FWER"), aes(x=Test, y=Mean, fill=Adjustment)) +
    scale_y_continuous(name='Proportion') +
    geom_bar(position = position_dodge(), stat="identity") +
    geom_linerange(position = position_dodge(width=.9), aes(ymin = CI_Low, ymax = CI_High)) +
    facet_grid(. ~ NumSubjects) +
    theme_bw() + coord_cartesian(ylim=c(0,.50))

ggplot(filter(summary_per_cell_fa, Measure=="ErrorRate"), aes(x=Test, y=Mean, fill=Adjustment)) +
    scale_y_continuous(name='Proportion') +
    geom_bar(position = position_dodge(), stat="identity") +
    geom_linerange(position = position_dodge(width=.9), aes(ymin = CI_Low, ymax = CI_High)) +
    facet_grid(. ~ NumSubjects) +
    theme_bw()+ coord_cartesian(ylim=c(0,.50))
```

```{r}
summary_per_cell_dr <- master_df %>%
  group_by(NumSubjects, NumItems, Pref, Alpha, Test, Adjustment) %>%
  summarise(DiscoverRate = get_mean_ci(CDBins/num_effect_time_bins),
            FWDR         = get_mean_ci(CDBins != 0)) %>%
  tidyr::gather(key = "Measure", value = "Value", DiscoverRate:FWDR) %>%
  tidyr::separate(col = Value, sep = ", ", into = c("Mean", "CI_Low", "CI_High"), remove = TRUE) %>%
  readr::type_convert()

ggplot(filter(summary_per_cell_dr, Measure=="FWDR"), aes(x=Test, y=Mean, fill=Adjustment)) +
    scale_y_continuous(name='Proportion') +
    geom_bar(position = position_dodge(), stat="identity") +
    geom_linerange(position = position_dodge(width=.9), aes(ymin = CI_Low, ymax = CI_High)) +
    facet_grid(Pref ~ NumSubjects) +
    theme_bw() + coord_cartesian(ylim=c(0,1))

ggplot(filter(summary_per_cell_dr, Measure=="DiscoverRate"), aes(x=Test, y=Mean, fill=Adjustment)) +
    scale_y_continuous(name='Proportion') +
    geom_bar(position = position_dodge(), stat="identity") +
    geom_linerange(position = position_dodge(width=.9), aes(ymin = CI_Low, ymax = CI_High)) +
    facet_grid(Pref ~ NumSubjects) +
    theme_bw()+ coord_cartesian(ylim=c(0,1))
```




