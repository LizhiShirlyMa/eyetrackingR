---
title: "Testing Types of Divergence Analyses with Simulations"
author: "Jacob Dink"
date: "November 17, 2015"
output: html_document
---

## Prelims:
```{r}
stopifnot(grepl(pattern = "Misc", x = getwd()))
#devtools::install_github('jwdink/eyetrackingR')
library(eyetrackingR)
library(pbapply)
library(dplyr)

params_to_test_template <- expand.grid(NumSubjects = c(10,30,60),
                                       NumItems    = c(10),
                                       Pref        = c(.65, .75, .85),
                                       SimNum      = 1:20)
effect_start <- 2500
trial_length <- 5000
tb_size <- 100
num_time_bins <- trial_length / tb_size
num_no_effect_time_bins <- (effect_start/trial_length)*num_time_bins
num_effect_time_bins    <- (1-effect_start/trial_length)*num_time_bins
bootstrap_samples <- 250
cluster_samples <- 250
```

```{r}
make_time_data <- function(i, param_df) {
  df <- simulate_eyetrackingr_data(num_participants = param_df[i,"NumSubjects"], 
                                   num_items_per_condition = param_df[i,"NumItems"], 
                                   trial_length = trial_length, 
                                   pref = param_df[i,"Pref"],
                                   pref_window = c(effect_start, trial_length)
                                   )
  df_time <- make_time_sequence_data(data = df, time_bin_size = tb_size, aois = "AOI1", predictor_columns = "Condition",
                                     summarize_by = "Participant")
}
```

## T.Tests:

### Uncorrected:

```{r}
t_test_df <- params_to_test_template
t_test_df$Alpha <- .05
t_test_df$Test <- "t_test_uncorrected"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
t_test_results <- pblapply(X = 1:nrow(t_test_df), FUN = function(i) {
  df_time <- make_time_data(i, t_test_df)
  tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "t.test", alpha = t_test_df[i,"Alpha"], quiet=TRUE)
  tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
  return(tb_anal)
})
saveRDS(t_test_results, file = "sim_results/t_test_results.RDS")
```

```{r}
t_test_results <- readRDS("sim_results/t_test_results.RDS")

for (i in seq_along(t_test_results)) {
  model <- t_test_results[[i]]
  # add to df:
  t_test_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  t_test_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  t_test_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

### Bonf. Corrected

```{r}
t_test_bonf_df <- params_to_test_template
t_test_bonf_df$Alpha <- .05 / num_time_bins
t_test_bonf_df$Test <- "t_test_bonferroni"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
t_test_bonf_results <- pblapply(X = 1:nrow(t_test_bonf_df), FUN = function(i) {
  df_time <- make_time_data(i, t_test_bonf_df)
  tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "t.test", alpha = t_test_bonf_df[i,"Alpha"], quiet=TRUE)
  tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
  return(tb_anal)
})
saveRDS(t_test_bonf_results, file = "sim_results/t_test_bonf_results.RDS")
```

```{r}
t_test_bonf_results <- readRDS("sim_results/t_test_bonf_results.RDS")

for (i in seq_along(t_test_bonf_results)) {
  model <- t_test_bonf_results[[i]]
  # add to df:
  t_test_bonf_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  t_test_bonf_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  t_test_bonf_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

## Boot-Splines:

### Uncorrected:

```{r}
boot_splines_df <- params_to_test_template
boot_splines_df$Alpha <- .05
boot_splines_df$Test <- "boot_splines_uncorrected"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
boot_splines_results <- pblapply(X = 1:nrow(boot_splines_df), FUN = function(i) {
  df_time <- make_time_data(i, boot_splines_df)
  tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "boot_splines", 
                               samples = bootstrap_samples,
                               within_subj = FALSE,
                               alpha = boot_splines_df[i,"Alpha"], 
                               quiet=TRUE)
  tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
  return(tb_anal)
})
saveRDS(boot_splines_results, file = "sim_results/boot_splines_results.RDS")
```

```{r}
boot_splines_results <- readRDS("sim_results/boot_splines_results.RDS")

for (i in seq_along(boot_splines_results)) {
  model <- boot_splines_results[[i]]
  # add to df:
  boot_splines_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  boot_splines_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  boot_splines_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

### Bonf. Corrected:

```{r}
boot_splines_bonf_df <- params_to_test_template
boot_splines_bonf_df$Alpha <- .05  / num_time_bins
boot_splines_bonf_df$Test <- "boot_splines_bonf"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
boot_splines_bonf_results <- pblapply(X = 1:nrow(boot_splines_bonf_df), FUN = function(i) {
  df_time <- make_time_data(i, boot_splines_bonf_df)
  tb_anal <- analyze_time_bins(df_time, predictor_column = "Condition", test = "boot_splines", 
                               samples = bootstrap_samples,
                               within_subj = FALSE,
                               alpha = boot_splines_bonf_df[i,"Alpha"], 
                               quiet=TRUE)
  tb_anal$Sig <- with(tb_anal, !is.na(PositiveRuns|NegativeRuns))
  return(tb_anal)
})
saveRDS(boot_splines_bonf_results, file = "sim_results/boot_splines_bonf_results.RDS")
```

```{r}
boot_splines_bonf_results <- readRDS("sim_results/boot_splines_bonf_results.RDS")

for (i in seq_along(boot_splines_bonf_results)) {
  model <- boot_splines_bonf_results[[i]]
  # add to df:
  boot_splines_bonf_df[i,"FABins"] <- with(model, sum(Sig[Time <  effect_start]) )
  boot_splines_bonf_df[i,"CDBins"] <- with(model, sum(Sig[Time >= effect_start]) )
  boot_splines_bonf_df[i,"FirstDiscTime"] <- with(model, Time[Time >= effect_start & Sig][1] )
}
```

## Cluster Analysis:

### Using t-tests, with Low. Threshold:

```{r}
time_cluster_low_thresh_df <- params_to_test_template
time_cluster_low_thresh_df$ThresholdAlpha <- .10
time_cluster_low_thresh_df$Alpha <- .05
time_cluster_low_thresh_df$Test <- "time_cluster_low_thresh_ttest"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
time_cluster_low_thresh_results <- pblapply(X = 1:nrow(time_cluster_low_thresh_df), FUN = function(i) {
  df_time <- make_time_data(i, time_cluster_low_thresh_df)
  cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "t.test", 
                                    threshold = qt(p = time_cluster_low_thresh_df[i,"ThresholdAlpha"]/2, 
                                                   df = time_cluster_low_thresh_df[i,"NumSubjects"]) # <-- set thresh w/alpha
  )
  cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples, parallel = TRUE)
  return(cl_anal)
})
saveRDS(time_cluster_low_thresh_results, file = "sim_results/time_cluster_low_thresh_results.RDS")
```

```{r}
time_cluster_low_thresh_results <- readRDS("sim_results/time_cluster_low_thresh_results.RDS")

for (i in seq_along(time_cluster_low_thresh_results)) {
  model <- get_time_clusters(time_cluster_low_thresh_results[[i]])
  
  if (nrow(model) > 0) {
    model <- model %>%
    mutate(Sig = Probability < .05,
           PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
           ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
           DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
           ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
    filter(Sig)
    
    # add to df:
  time_cluster_low_thresh_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
  time_cluster_low_thresh_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
  time_cluster_low_thresh_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect), no = NA))
  }
  else {
    time_cluster_low_thresh_df[i,"FABins"] <- 0
    time_cluster_low_thresh_df[i,"CDBins"] <- 0
    time_cluster_low_thresh_df[i,"FirstDiscTime"] <- NA
  }
}
```

### Using t-tests, with High. Threshold:

```{r}
time_cluster_high_thresh_df <- params_to_test_template
time_cluster_high_thresh_df$ThresholdAlpha <- .05
time_cluster_high_thresh_df$Alpha <- .05
time_cluster_high_thresh_df$Test <- "time_cluster_high_thresh_ttest"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
time_cluster_high_thresh_results <- pblapply(X = 1:nrow(time_cluster_high_thresh_df), FUN = function(i) {
  df_time <- make_time_data(i, time_cluster_high_thresh_df)
  cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "t.test", 
                                    threshold = qt(p = time_cluster_high_thresh_df[i,"ThresholdAlpha"]/2, 
                                                   df = time_cluster_high_thresh_df[i,"NumSubjects"]) # <-- set thresh w/alpha
  )
  cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples, parallel = TRUE)
  return(cl_anal)
})
saveRDS(time_cluster_high_thresh_results, file = "sim_results/time_cluster_high_thresh_results.RDS")
```

```{r}
time_cluster_high_thresh_results <- readRDS("sim_results/time_cluster_high_thresh_results.RDS")

for (i in seq_along(time_cluster_high_thresh_results)) {
  model <- get_time_clusters(time_cluster_high_thresh_results[[i]])
  if (nrow(model) > 0) {
    model <- model %>%
      mutate(Sig = Probability < .05,
             PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
             ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
             DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
             ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
      filter(Sig)
    
    # add to df:
    time_cluster_high_thresh_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
    time_cluster_high_thresh_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
    time_cluster_high_thresh_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect), no = NA))
  }
  else {
    time_cluster_high_thresh_df[i,"FABins"] <- 0
    time_cluster_high_thresh_df[i,"CDBins"] <- 0
    time_cluster_high_thresh_df[i,"FirstDiscTime"] <- NA
  }
}
```

### Using boot-splines, with Low. Threshold:

```{r}
time_cluster_low_thresh_boot_df <- params_to_test_template
time_cluster_low_thresh_boot_df$ThresholdAlpha <- .10
time_cluster_low_thresh_boot_df$Alpha <- .05
time_cluster_low_thresh_boot_df$Test <- "time_cluster_low_thresh_boot"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
time_cluster_low_thresh_boot_results <- pblapply(X = 1:nrow(time_cluster_low_thresh_boot_df), FUN = function(i) {
  df_time <- make_time_data(i, time_cluster_low_thresh_boot_df)
  cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "boot_splines", within_subj = FALSE,
                                    alpha = time_cluster_low_thresh_boot_df[i,"ThresholdAlpha"])
  cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples,
                                   boot_samples = bootstrap_samples,
                                   parallel = TRUE)
  return(cl_anal)
})
saveRDS(time_cluster_low_thresh_boot_results, file = "sim_results/time_cluster_low_thresh_boot_results.RDS")
```

```{r}
time_cluster_low_thresh_boot_results <- readRDS("sim_results/time_cluster_low_thresh_boot_results.RDS")

for (i in seq_along(time_cluster_low_thresh_boot_results)) {
  model <- get_time_clusters(time_cluster_low_thresh_boot_results[[i]])
  if (nrow(model) > 0) {
    model <- model %>%
      mutate(Sig = Probability < .05,
             PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
             ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
             DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
             ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
      filter(Sig)
    
    # add to df:
    time_cluster_low_thresh_boot_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
    time_cluster_low_thresh_boot_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
    time_cluster_low_thresh_boot_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect), no = NA))
  }
  else {
    time_cluster_low_thresh_boot_df[i,"FABins"] <- 0
    time_cluster_low_thresh_boot_df[i,"CDBins"] <- 0
    time_cluster_low_thresh_boot_df[i,"FirstDiscTime"] <- NA
  }
}
```

### Using boot-splines, with High. Threshold:

```{r}
time_cluster_high_thresh_boot_df <- params_to_test_template
time_cluster_high_thresh_boot_df$ThresholdAlpha <- .05
time_cluster_high_thresh_boot_df$Alpha <- .05
time_cluster_high_thresh_boot_df$Test <- "time_cluster_high_thresh_boot"
```

```{r, eval=TRUE}
# set eval to FALSE after this has been run once.
time_cluster_high_thresh_boot_results <- pblapply(X = 1:nrow(time_cluster_high_thresh_boot_df), FUN = function(i) {
  df_time <- make_time_data(i, time_cluster_high_thresh_boot_df)
  cl_dat  <- make_time_cluster_data(df_time, predictor_column = "Condition", test = "boot_splines", within_subj = FALSE,
                                    alpha = time_cluster_high_thresh_boot_df[i,"ThresholdAlpha"])
  cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = cluster_samples,
                                   boot_samples = bootstrap_samples,
                                   parallel = TRUE)
  return(cl_anal)
})
saveRDS(time_cluster_high_thresh_boot_results, file = "sim_results/time_cluster_high_thresh_boot_results.RDS")
```

```{r}
time_cluster_high_thresh_boot_results <- readRDS("sim_results/time_cluster_high_thresh_boot_results.RDS")

for (i in seq_along(time_cluster_high_thresh_boot_results)) {
  model <- get_time_clusters(time_cluster_high_thresh_boot_results[[i]])
  if (nrow(model) > 0) {
    model <- model %>%
      mutate(Sig = Probability < .05,
             PreEffectTime = ifelse(effect_start-StartTime > 0, effect_start-StartTime, 0),
             ClusterStartTimeWithinEffect = ifelse(effect_start <= StartTime, StartTime, effect_start),
             DuringEffectTime = ifelse(EndTime >= effect_start, EndTime - ClusterStartTimeWithinEffect, 0),
             ClusterStartTimeWithinEffect = ifelse(DuringEffectTime==0, NA, ClusterStartTimeWithinEffect)) %>%
      filter(Sig)
    
    # add to df:
    time_cluster_high_thresh_boot_df[i,"FABins"] <- with(model, sum(PreEffectTime) / tb_size)
    time_cluster_high_thresh_boot_df[i,"CDBins"] <- with(model, sum(DuringEffectTime[Direction=="Positive"]) / tb_size)
    time_cluster_high_thresh_boot_df[i,"FirstDiscTime"] <- with(model, ifelse(sum(!is.na(ClusterStartTimeWithinEffect))>0, yes = min(ClusterStartTimeWithinEffect), no = NA))
  }
  else {
    time_cluster_high_thresh_boot_df[i,"FABins"] <- 0
    time_cluster_high_thresh_boot_df[i,"CDBins"] <- 0
    time_cluster_high_thresh_boot_df[i,"FirstDiscTime"] <- NA
  }
}
```


```{r}
#[WILL INSERT SUMMARY/GRAPH CODE HERE, do not edit]

master_df <- bind_rows(boot_splines_bonf_df, boot_splines_df, 
                       t_test_bonf_df, t_test_df, 
                       time_cluster_low_thresh_df, time_cluster_high_thresh_df,
                       time_cluster_low_thresh_boot_df, time_cluster_low_thresh_df)

# print the date so I can see how long this took
date()

```




