---
title: "Testing Properties of Divergence Analyses with Simulations (2)"
author: "Jacob Dink"
date: "November 15, 2015"
output: html_document
---

```{r, echo=FALSE}
#devtools::install_github('jwdink/eyetrackingR')
library("eyetrackingR")
library("ggplot2")
suppressPackageStartupMessages(library("dplyr"))
library("pbapply")
suppressPackageStartupMessages(library("foreach"))
doMC::registerDoMC()

#set.seed(40)

tb_size <- 100
sim_factor <- 50 # of simulations for each Nsubjects/Nitems/pref cell

  # create vectors for permutations
  N_subjects = rep(c(30), each=sim_factor)
  N_items = c(10)
  pref = c(.60,.75,.90)

n_bootstrap_samples <- 250 # (for clusters and bootstraps)
effect_start <- 2500
trial_length <- 5000
num_time_bins <- trial_length / tb_size
fdr_correction <- trial_length / 250 # set based on independent saccade bins.... experimental
```


```{r}
clusters <- data.frame(
                  test = 'boot_spline_clusters',
                  correction_factor = 0,
                  effective_alpha = .05
              ) %>%
  cbind(expand.grid(N_subjects = N_subjects, 
                    N_items = N_items, 
                    pref = pref))

cluster_results <- pblapply(1:nrow(clusters), FUN = function(i) {
  
  # begin analysis
  df <- simulate_eyetrackingr_data(num_participants = clusters[i,"N_subjects"], 
                                   num_items_per_condition = clusters[i,"N_items"], 
                                   pref = clusters[i,"pref"], 
                                   pref_window = c(effect_start,trial_length))
  df_time_sub <- make_time_sequence_data(df, time_bin_size = tb_size, predictor_columns = "Condition", 
                                         aois = "AOI1", summarize_by = "Participant")
  
  cl_dat <- make_time_cluster_data(data = df_time_sub, predictor_column = "Condition", test = "boot_splines",
                                   within_subj = FALSE,
                                   alpha = .10, formula = Elog ~ Condition)
  if ( nrow(get_time_clusters(cl_dat))>0 ) {
    cl_anal <- analyze_time_clusters(cl_dat, within_subj = FALSE, samples = n_bootstrap_samples, 
                                     boot_samples  = n_bootstrap_samples,
                                     parallel = TRUE)
    cl_clusts <- get_time_clusters(cl_anal)
    cl_clusts$NumBins <- with(cl_clusts, (EndTime - StartTime)/tb_size)
    cl_sig_clusts <- filter(cl_clusts, cl_clusts$Probability<.05)
    out <- with(cl_sig_clusts, 
                data.frame(
                  N_subjects = clusters[i,"N_subjects"],
                  N_items = clusters[i,"N_items"],
                  pref = clusters[i,"pref"], 
                  avg_rt = mean(df$RT, na.rm=TRUE),
                  rt_lower_quart = quantile(df$RT, probs = .25),
                  rt_upper_quart = quantile(df$RT, probs = .75),
                  false_alarm_bins = sum((EndTime[EndTime < (effect_start-tb_size) & StartTime < (effect_start-tb_size)] - StartTime[EndTime < (effect_start-tb_size) & StartTime < (effect_start-tb_size)])/tb_size, ((effect_start-tb_size)-StartTime[EndTime >= (effect_start-tb_size) & StartTime < (effect_start-tb_size)])/tb_size),
                  correct_discovery_bins = sum((EndTime[StartTime >= (effect_start-tb_size)] - StartTime[StartTime >= (effect_start-tb_size)])/tb_size, (EndTime[StartTime < (effect_start-tb_size) & EndTime > (effect_start-tb_size)]-(effect_start-tb_size))/tb_size),
                  first_discovery_time = StartTime[EndTime >= (effect_start-tb_size)][1],
                  n_clusters = length(Cluster) # <--- changed so only significant clusters
                )  
    )
  } else {
    out <- data.frame(
      N_subjects = clusters[i,"N_subjects"],
      N_items = clusters[i,"N_items"],
      pref = clusters[i,"pref"], 
      avg_rt = mean(df$RT, na.rm=TRUE),
      rt_lower_quart = quantile(df$RT, probs = .25),
      rt_upper_quart = quantile(df$RT, probs = .75),
      false_alarm_bins = 0,
      correct_discovery_bins = 0,
      first_discovery_time = NA,
      n_clusters = 0
    )
  }
  # end analysis
  
  # begin return data
  return(out)
  # end return data
  
})

# merge results into dataframe
#clusters <- left_join(clusters, bind_rows(cluster_results))
```
